<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Plan your Worldtrip</title>
    <style type="text/css">
        body {
            color: #5d5d5d;
            font-family: Helvetica, Arial, sans-serif;
        }

        h1 {
            font-size: 30px;
            margin: auto;
            margin-top: 50px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            border: 1px solid #bebeb4;
            padding: 10px;
        }

        /* Specific mapael css class are below
         * 'mapael' class is added by plugin
        */

        .mapael .map {
            position: relative;
        }

        .mapael .mapTooltip {
            position: absolute;
            background-color: #fff;
            moz-opacity: 0.70;
            opacity: 1.00;
            filter: alpha(opacity=70);
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
            max-width: 200px;
            display: none;
            color: #343434;
        }

        .mapael .myLegend {
            width: 400px;
            border: 1px solid #bebeb4;
            background-color: #ffffff;
            width: 200px;
            padding: 10px;
            float: right;
        }

                /* For all zoom buttons */
        .mapael .zoomButton {
            background-color: #fff;
            border: 1px solid #ccc;
            color: #000;
            width: 15px;
            height: 15px;
            line-height: 15px;
            text-align: center;
            border-radius: 3px;
            cursor: pointer;
            position: absolute;
            top: 0;
            font-weight: bold;
            left: 10px;

            -webkit-user-select: none;
            -khtml-user-select : none;
            -moz-user-select: none;
            -o-user-select : none;
            user-select: none;
        }

        /* Reset Zoom button first */
        .mapael .zoomReset {
            top: 10px;
        }

        /* Then Zoom In button */
        .mapael .zoomIn {
            top: 30px;
        }

        /* Then Zoom Out button */
        .mapael .zoomOut {
            top: 50px;
        }



        #overlay {
            position: fixed;
            height: 100%; 
            width: 100%;
            top: 0;
            right: 0;  
            bottom: 0;
            left: 0;
            background: rgba(0,0,0,0.8);
            display: none;
        }

        #popup {
            max-width: 400px;
            width: 80%;
            max-height: 150px;
            height: 80%; 
            padding: 20px;
            position: relative;
            background: #47CEBE;
            margin: 20px auto;
        }

        #close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #000;
        }



    </style>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <!--<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ycodetech/horizontal-timeline-2.0@2/css/horizontal_timeline.2.0.min.css">-->
    <link rel="stylesheet" type="text/css" href="./css/horizontal_timeline.2.0.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-bootstrap/0.5pre/css/custom-theme/jquery-ui-1.10.0.custom.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"
            charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js" charset="utf-8"></script>
    <script src="./jquery.mapael.js" charset="utf-8"></script>
    <script src="./maps/world/world_countries.js" charset="utf-8"></script>
    <!--<script src="./world_countries.js" charset="utf-8"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" charset="utf-8"></script>
    <script src="./js/horizontal_timeline.2.0.min.js"></script>
                

    <script type="text/javascript">

        // This variable will hold all the weather data of our map
        var weather  = {};
        var areas = {};
        // This variable will hold all the plots of our map
        var plots = {};
        var startcity = "";

        $(function () {

            // Show loading message
            $(".mapcontainer span").html("Loading...").css({"color":"#2a9d8f", "font-weight":"bold"});

            // We need a setTimeout (~200ms) in order to allow the UI to be refreshed for the message to be shown
            setTimeout(function(){

                // Get the city data
                $.getJSON("https://markusxyz.github.io/ressources/weather.json", function (data) {
                    // Success

                    //var areas = {};
                    // Parse each elements
                    $.each(data, function (id, elem) {
                        var area = {};
                        var tooltip;
                        var content = "";
                        var color = "";
                        var traveltime = "<span style=\"font-weight:bold;\">" + elem.Name + "<\/span><br \/>";
                        var monatsabkuerzung = ["J","F","M","A","M","J","J","A","S","O","N","D"];

                        //
                        //
                        //
                        // Aufbau Tooltip Wetter Uebersicht

                        for (let index = 0; index <= 11; index++) {

                            switch(elem.Monate[index])
                            {
                            case 0:
                            color = "#2A9D8F";
                            break;

                            case 1:
                            color = "#47CEBE";
                            break;

                            case 2:
                            color = "#F4A261";
                            break;

                            case 3:
                            color = "#E76F51";
                            break;

                            case 4:
                            color = "#E9C46A";
                            break;

                            default:
                            color = "#a7aea5";
                            }

                            if (index == 0){
                                traveltime = traveltime + "<table style=\" table-layout: fixed; width: 100%\"><tr style=\"color:#424242; font-size:90%\"><td style=\" width: 8%\" bgcolor=\"" + color + "\">" + monatsabkuerzung[index] + "<\/td>"
                            }
                            else if (index == 11){
                                traveltime = traveltime + "<td style=\" width: 8%\" bgcolor=\"" + color + "\">" + monatsabkuerzung[index] + "<\/td><\/tr><\/table>"
                            }
                            else{
                                traveltime = traveltime + "<td style=\" width: 8%\" bgcolor=\"" + color + "\">" + monatsabkuerzung[index] + "<\/td>"
                            }
                        }

                        //
                        //
                        //
                        // Bau des areas array

                        if (areas[elem.Country] != null){
                            var tmp = areas[elem.Country];
                            tooltip = tmp.tooltip;
                            var content = tooltip.content;
                            //console.warn(elem.Country);
                        }
 
                        if (elem.Part){
                            weather[elem.Country+"-"+elem.Part] = elem.Monate;
                            
                        }
                        else{
                            weather[elem.Country] = elem.Monate;
                            
                        };

                        area.name = elem.Name;
                        area.tooltip = {
                            content: content + traveltime
                        }
                        areas[elem.Country] = area;
                        
                    });
                });

                // Get the city data
                $.getJSON("https://markusxyz.github.io/ressources/worldcities.json", function (data) {
                    // Success
                    // Parse each elements
                    $.each(data, function (id, elem) {
                        //$('<option value="' + elem.city + '">' + elem.city + '</option>').appendTo("#choose_start");
                        // Check if we have the GPS position of the element
                        if (elem.capital == "primary" || elem.capital == "admin" || elem.airport != "NV") {
                        //if ((elem.airport != 0 && elem.airport != "NV")) {
                            // Will hold the plot information
                            var plot = {};
                            // Assign position
                            plot.latitude = elem.latitude;
                            plot.longitude = elem.longitude;
                            // Assign some information inside the tooltip
                            plot.tooltip = {
                                content: "<span style='font-weight:bold;'>" +
                                            elem.city + " (" + elem.population + ")" +
                                        "</span>" +
                                        "<br/>Country " + elem.country + ")"
                            };
                            //Color city plots
                            /*if (elem.capital == "primary"){
                                plot.attrs = {fill: "#cf2835"};
                            }
                            else {
                                plot.attrs = {fill: "#2579b5"};
                            }*/


                            plot.country = elem.country;
                            plot.iso2 = elem.iso2;
                            plot.value = elem.population;
                            plot.city = elem.city;
                            // Set plot element to array
                            plots[elem.city] = plot;
                        } else {
                            //console.warn("Ignored element " + id + " without GPS position");
                        }

                    });

                $(".mapcontainer").mapael({
                    map: {
                        name: "world_countries",
                        zoom: {
                            enabled: true,
                            maxLevel: 50
                        },
                        defaultArea: {
                            attrs: {
                                stroke: "#fff",
                                "stroke-width": 1,
                                fill: "#BDD6E0"
                            },
                            eventHandlers: {
                                click: function (e, id, mapElem, textElem, elemOptions) {

                                    $(".mapcontainer").trigger('zoom', {
                                        area: id,
                                        areaMargin: 10
                                    });

                                    var tmpPlots = {};

                                    Object.values(plots).forEach(plot => {
                                        if (plot.iso2 == id) {
                                            //console.warn(plot.iso2);
                                            tmpPlots[plot.city] = plot;
                                            plots[plot.city].flag = 0;                                    }
                                    });

                                    var updatedOptions = {};
                                    //Filter smaller Citys
                                    updatedOptions.legend = {
                                        plot: {
                                            slices: [{
                                                clicked: true
                                            }, {
                                                clicked: true
                                            }, {
                                                clicked: true
                                            }, {
                                                clicked: false
                                            }]
                                        }
                                    };

                                    $(".mapcontainer").trigger('update', [{
                                                    mapOptions: updatedOptions, 
                                                    newPlots: tmpPlots,
                                                    animDuration: 2000
                                                }]);
                                }
                            }
                        },
                        defaultPlot: {
                            fill: "#2579b5",
                            eventHandlers: {
                                click: function (e, id) {

                                    $(".mapcontainer").trigger('zoom', {level: 0});

                                    var tmp = $('#timeline>div>ol li:last').attr('data-horizontal-timeline');
                                    var lastcity = "";

                                    lastcity = jQuery.parseJSON(tmp).customDisplay;
                                    if (lastcity == "Start"){
                                        lastcity = startcity;
                                        console.warn(lastcity);
                                        if (startcity == ""){
                                            $( "#popup>h2" ).text('City to Start');
                                            $( "#popup>p" ).text('Please choose the city, where you want to start from.');
                                            $('#overlay').fadeIn(300);
                                            return
                                        }
                                    }

                                    if (jQuery.parseJSON(tmp).date == $( "#start_date_picker" ).val()){
                                        $( "#popup>h2" ).text('Choose different start date');
                                        $( "#popup>p" ).text('Please don\'t choose the same date as end date from your previous location and start date for your next location');
                                        $('#overlay').fadeIn(300);
                                        return
                                    }

                                    //Set target city to not delete again
                                    plots[id].flag = 1;

                                    //delete not used plots and keep used plots
                                    var tmpPlots = {};
                                    var deletedPlots = [];

                                    Object.values(plots).forEach(plot => {
                                        if (plot.flag == 1) {
                                            //console.warn(plot.iso2);
                                            tmpPlots[plot.city] = plot;
                                        }
                                        if (plot.flag == 0){
                                            deletedPlots.push(plot.city);
                                        }                                   
                                    });

                                    //console.warn(id + " " + lastcity);
                                    // Draw ne line
                                    var opt = {
                                                [id] : {
                                                    factor: -0.5
                                                    , between: [lastcity, id]
                                                    , attrs: {
                                                        "stroke-width": 2
                                                        , 'stroke': '#219ebc'
                                                    }
                                                }
                                            };

                                    var updatedOptions = {};
                                    //Filter smaller Citys
                                    updatedOptions.legend = {
                                        plot: {
                                            slices: [{
                                                clicked: false
                                            }, {
                                                clicked: false
                                            }, {
                                                clicked: false
                                            }, {
                                                clicked: false
                                            }]
                                        }
                                    };
                                    
                                    $(".mapcontainer").trigger('update', {
                                            mapOptions: updatedOptions,
                                            animDuration: 1000,
                                            'newLinks': opt,
                                            newPlots: tmpPlots,
                                            deletePlotKeys: deletedPlots
                                    });

                                    // Make Enddate to Startdate
                                    $( "#start_date_picker" ).val($( "#end_date_picker" ).val());
                                    
                                    var html = "<li data-horizontal-timeline='{\"date\": \"" + $( "#start_date_picker" ).val() + "\", \"customDisplay\": \"" + id + "\", \"enddate\": \"" + $( "#end_date_picker" ).val() + "\"}'>" + id + "</li>";

							        $('#timeline').horizontalTimeline('addEvent', html, 'after', jQuery.parseJSON(tmp).date);

                                    // Smooth scroll enabled with all options set.
						            $('#timeline').horizontalTimeline('goTo', $( "#start_date_picker" ).val(), {smoothScroll: true, speed: 1000, offset: 100, easing: "easeInQuad"});

                                    selectmonth();

                                    /*$(".mapcontainer").trigger('update', [{
                                            setLegendElemsState: {"mylegend": "hide"},
                                            animDuration: 1000
                                        }]);*/
                                }
                            }
                        }
                    },
                    legend: {
                            plot: {
                                cssClass: 'myLegend',
                                mode: "vertical",
                                labelAttrs: {
                                    fill: "#4a4a4a"
                                },
                                titleAttrs: {
                                    fill: "#4a4a4a"
                                },
                                marginBottom: 20,
                                marginLeft: 30,
                                hideElemsOnClick: {
                                    opacity: 0
                                },
                                title: "Cities populations",
                                slices: [{
                                    size: 1,
                                    type: "circle",
                                    max: 100000,
                                    attrs: {
                                        //fill: "#f99200"
                                        fill: "#495057"
                                    },
                                    label: "< 100 000 inhabitants",
                                    clicked: false
                                }, {
                                    size: 2,
                                    type: "circle",
                                    min: 100000,
                                    max: 500000,
                                    attrs: {
                                        fill: "#495057"
                                    },
                                    label: "> 100 000 and 500 000",
                                    clicked: false
                                }, {
                                    size: 3,
                                    type: "circle",
                                    min: 500000,
                                    max: 1000000,
                                    attrs: {
                                        fill: "#495057"
                                    },
                                    label: "> 500 000 and 1 000 000",
                                    clicked: false
                                }, {
                                    size: 4,
                                    type: "circle",
                                    min: 1000000,
                                    attrs: {
                                        fill: "#495057"
                                    },
                                    label: "> 1 000 000",
                                    clicked: false
                                }]
                            }
                        },
                    areas: areas//,
                    // Alle aus JSON File ausgelesene Städte
                    //plots: plots
                });
                            
                $( "#startcity" ).autocomplete( {
                    source: Object.keys(plots),
                    select: function (event, ui) {

                        var deletedPlots = [""];

                        if (startcity != ""){
                            deletedPlots = [startcity];
                            plots[startcity].flag = 0;
                        }

                        startcity = ui.item.value;

                        var tmpPlots = {};
                        tmpPlots[startcity] = plots[startcity];
                        plots[startcity].flag = 1;
                        //tmpPlots[startcity].size = 20;

                        $(".mapcontainer").trigger('update', [{
                                        //mapOptions: updatedOptions, 
                                        newPlots: tmpPlots,
                                        deletePlotKeys: deletedPlots,
                                        animDuration: 2000
                                    }]);
                    }
                });

                }).fail(function() {
                    // Error
                    $(".mapcontainer span").html("Failed to load JSON data").css({"color":"red"});
                });
            }, 200);
            
        });

        function selectmonth(){

            if ($( "#start_date_picker" ).datepicker('getDate') == null){
                $( "#popup>h2" ).text('Choose Date');
                $( "#popup>p" ).text('Please choose a date when you like to start.');
                $('#overlay').fadeIn(300);
                return
            }
            var startmonth = $( "#start_date_picker" ).datepicker('getDate').getMonth() + 1;
            var endmonth = ($( "#end_date_picker" ).datepicker('getDate') == null) ? $( "#start_date_picker" ).datepicker('getDate').getMonth() + 1 : $( "#end_date_picker" ).datepicker('getDate').getMonth() + 1;
            
            var month = [];

            if (startmonth < endmonth){
                for (let index = startmonth; index <= endmonth; index++) {
                    month.push(index);
                }
            }
            if (startmonth > endmonth){
                for (let index = startmonth; index <= 12; index++) {
                    month.push(index);
                }
                for (let index = 1; index <= endmonth; index++) {
                    month.push(index);
                }
            }
            if (startmonth == endmonth){
                month.push(startmonth);
            }

            var updatedOptions = {'areas': {}};

            for ( const [key,value] of Object.entries( weather ) ) {

                var flagBestWeather = 0;
                var flagGoodWeather = 0;
                var flagOKWeather = 0;
                var flagBadWeather = 0;
                var flagMixWeather = 0;

                month.forEach(checkWeather);

                function checkWeather(month, index){

                    // startmonth - 1 da array bei 0 anfaengt
                    month = month - 1;

                    if (weather[key][month] == 0) {
                        flagBestWeather = 1;
                    }

                    if (weather[key][month] == 1) {
                        flagGoodWeather = 1;
                    }

                    if (weather[key][month] == 2) {
                        flagOKWeather = 1;
                    }

                    if (weather[key][month] == 3) {

                        flagBadWeather = 1;        
                    }

                    if (weather[key][month] == 4) {

                        flagMixWeather = 1;        
                    }
                }

                if (flagBestWeather && !flagGoodWeather && !flagOKWeather && !flagBadWeather && !flagMixWeather) {
                    updatedOptions.areas[key] = {
                            attrs: {
                                fill: "#2A9D8F"
                            }
                        };
                }

                if (flagGoodWeather && !flagOKWeather && !flagBadWeather && !flagMixWeather) {
                    updatedOptions.areas[key] = {
                            attrs: {
                                fill: "#47CEBE"
                            }
                        };
                }

                if (flagOKWeather && !flagBadWeather && !flagMixWeather) {
                    updatedOptions.areas[key] = {
                            attrs: {
                                fill: "#F4A261"
                            }
                        };
                }

                if (flagBadWeather  && !flagMixWeather) {
                    updatedOptions.areas[key] = {
                            attrs: {
                                fill: "#E76F51"
                            }
                        };
                }

                if (flagMixWeather) {
                    updatedOptions.areas[key] = {
                            attrs: {
                                fill: "#E9C46A"
                            }
                        };
                }

            };

            //Filter smaller Citys
            /*updatedOptions.legend = {
                plot: {
                    slices: [{
                        clicked: true
                    }, {
                        clicked: true
                    }, {
                        clicked: true
                    }, {
                        clicked: true
                    }]
                }
            };*/
            $(".mapcontainer").trigger('update', [{
                            mapOptions: updatedOptions, 
                            animDuration: 1000
                        }]);
        };

      $(document).ready(function() {

        $('#timeline').horizontalTimeline();

        /* The Defaults */
        $('#timeline').horizontalTimeline({ 
					dateIntervals: {
						"desktop": 150,
						"tablet": 150,
						"mobile": 120,
						"minimal": true},

					
					dateDisplay: "date", // dateTime, date, time, dayMonth, monthYear, year
					dateOrder: "normal", // normal, reverse
																			
					autoplay: false,
					autoplaySpeed: 8,
					autoplayPause_onHover: false, 
					
					useScrollWheel: false,
					useTouchSwipe: true,
					useKeyboardKeys: false,
					addRequiredFile: true,
					useFontAwesomeIcons: true,
					useNavBtns: true,
					useScrollBtns: true,
					
					iconClass: {
						"base": "fas fa-3x", // Space separated class names
						"scrollLeft": "fa-chevron-circle-left",
						"scrollRight": "fa-chevron-circle-right",
						"prev": "fa-arrow-circle-left",
						"next": "fa-arrow-circle-right",
						"pause": "fa-pause-circle",
						"play": "fa-play-circle"},
					animationClass: {
						"base": "animationSpeed", // Space separated class names
						"enter": {
							"left": "enter-left",
							"right": "enter-right"},
						"exit": {
							"left": "exit-left",
							"right": "exit-right"}}

        }); 
          
        $(function() {
        
            //
            //
            // End Date Picker
            $( "#end_date_picker" ).datepicker(
                {
                    dateFormat: 'dd/mm/yy',
                    inline: true,
                    onSelect: function(dateText, inst) { 
                        selectmonth();
                    }
                }
            );

            //
            //
            // Start Date Picker
            $( "#start_date_picker" ).datepicker(
                {
                    dateFormat: 'dd/mm/yy',
                    inline: true,
                    onSelect: function(dateText, inst) { 
                        $( "#end_date_picker" ).datepicker().datepicker("setDate", $( "#start_date_picker" ).datepicker("getDate"));
                        selectmonth();
                    }
                }
            );

            //
            //
            // Remove Button
            $( "#remove_button" ).click( function( event ) {

                // Get latest Event in timeline
                var tmp = $('#timeline>div>ol li:last').attr('data-horizontal-timeline');

                $( "#start_date_picker" ).val(jQuery.parseJSON(tmp).date);
                
                plots[jQuery.parseJSON(tmp).customDisplay].flag = 0;

                // Remove connection
                var opt = {
                    animDuration: 1000,
                    'deleteLinkKeys': [jQuery.parseJSON(tmp).customDisplay],
                    deletePlotKeys: [jQuery.parseJSON(tmp).customDisplay]
                };

                $(".mapcontainer").trigger('update', [opt]);

                // Remove Event from Timeline
                var tmp = $('#timeline>div>ol li:last').attr('data-horizontal-timeline');

                $('#timeline').horizontalTimeline('removeEvent', jQuery.parseJSON(tmp).date);

                selectmonth();
            } );

            // Popup Close Event
            $('#close').click(function() {
                $('#overlay').fadeOut(300);
            });


            // Click Timeline and change Start and End Date and refresh map
            $('#timeline').on("eventChanged.horizontalTimeline", function(event){ 
                //console.warn($('#timeline>div>ol'));
                $('#timeline>div>ol li').each(function() {  
                    //console.warn();
                    if (event.currentEventDate == jQuery.parseJSON($(this).attr('data-horizontal-timeline')).date) {

                        $( "#start_date_picker" ).val(jQuery.parseJSON($(this).attr('data-horizontal-timeline')).date);
                        
                        if (jQuery.parseJSON($(this).attr('data-horizontal-timeline')).enddate){
                            $( "#end_date_picker" ).val(jQuery.parseJSON($(this).attr('data-horizontal-timeline')).enddate);
                        }
                        else {
                            $( "#end_date_picker" ).val(jQuery.parseJSON($(this).attr('data-horizontal-timeline')).date);
                        }
                        selectmonth();
                    }
                    
                    
                });
                //console.warn(event);

            });
            
        });
    })
    </script>

</head>

<body>
<div class="container">

    <h1>Plan your Worldtrip</h1>
    <br>
    <div class="mapcontainer">
        <div class="map">
            <span>Alternative content for the map</span>
        </div>
        <div class="myLegend">
            <span>Alternative content for the legend</span>
        </div>
        <br>
    </div>
    <div>
        <input type="text" id="startcity" placeholder="City to start from"/>
        <input type="text" id="start_date_picker" placeholder="Start Date">
        <input type="text" id="end_date_picker" placeholder="End Date">
        <i class="fas fa-trash-alt" id="remove_button"></i>
    </div>

    <div class="horizontal-timeline" id="timeline"> 
        <div class="events-content"> 
            <ol> 
                <li class="selected" data-horizontal-timeline='{"date": "01/01/2000", "customDisplay": "Start"}'> Your Trip starts here! </li>
            </ol> 
        </div> 
    </div> 
        

        <!--<div class="areaLegend">
            <span>Alternative content for the legend</span>
        </div>-->

    
    <div id="overlay">
        <div id="popup">
           <div id="close">X</div>
           <i class="fas fa-ban fa-3x"></i>
           <h2>City to Start</h2>
           <p>Please choose the city, where you want to start from.</p>
        </div>
    </div>
</div>


</body>
</html>
